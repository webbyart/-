<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>แบบฟอร์มขอยืมอุปกรณ์</title>
    <link rel="stylesheet" href="index.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;700&display=swap" rel="stylesheet">
<script type="importmap">
{
  "imports": {
    "jspdf": "https://aistudiocdn.com/jspdf@^3.0.3",
    "@supabase/supabase-js": "https://aistudiocdn.com/@supabase/supabase-js@^2.57.4",
    "html2canvas": "https://aistudiocdn.com/html2canvas@^1.4.1",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
    "firebase/messaging": "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js",
    "firebase/": "https://aistudiocdn.com/firebase@^12.3.0/"
  }
}
</script>
</head>
<body>
    <main id="app-container">
        <header>
            <img src="https://storage.googleapis.com/aip-dev-source-public/sumino-aapico-logo.png" alt="SUMINO AAPICO Logo" class="company-logo">
            <h1>แบบฟอร์มขอยืมอุปกรณ์</h1>
        </header>

        <!-- Notification Controls -->
        <section id="notification-control" class="form-section">
            <h2>การแจ้งเตือน</h2>
            <p>เปิดใช้งานการแจ้งเตือนเพื่อรับข่าวสารล่าสุดเกี่ยวกับคำขอยืมของคุณ</p>
            <div class="submission-area">
                <button type="button" id="enable-notifications-button" class="primary-button">เปิดใช้งานการแจ้งเตือน</button>
            </div>
            <p id="notification-status"></p>
        </section>


        <!-- Step 1: Loan Request Form -->
        <div id="form-step">
            <p>กรุณากรอกข้อมูลเพื่อขอยืมอุปกรณ์ของบริษัท</p>
            <form id="loan-form">
                <section class="form-section">
                    <h2>1. ข้อมูลพนักงานและทรัพย์สิน</h2>
                    <div class="form-group">
                        <label for="employeeSelect">รหัสพนักงาน</label>
                        <div class="employee-selector-container">
                            <select id="employeeSelect" name="employeeId" required>
                                <option value="" disabled selected>-- เลือกพนักงาน --</option>
                            </select>
                            <img id="employeeImage" alt="รูปพนักงาน" class="employee-image-preview hidden">
                            <button type="button" id="view-history-button" class="secondary-button" disabled>ดูประวัติการยืม</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="employeeName">ชื่อพนักงาน</label>
                        <input type="text" id="employeeName" name="employeeName" readonly required>
                    </div>
                    <div class="form-group">
                        <label for="assetId">รหัสทรัพย์สิน / Serial Number</label>
                        <input type="text" id="assetId" name="assetId" required>
                    </div>
                </section>

                <section class="form-section">
                    <h2>2. อุปกรณ์เสริม</h2>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="accessories" value="charger"> ที่ชาร์จ</label>
                        <label><input type="checkbox" name="accessories" value="mouse"> เมาส์</label>
                        <label><input type="checkbox" name="accessories" value="bag"> กระเป๋า</label>
                        <label><input type="checkbox" name="accessories" value="keyboard"> คีย์บอร์ด</label>
                    </div>
                    <div class="form-group">
                        <label for="otherAccessories">อื่นๆ (โปรดระบุ)</label>
                        <input type="text" id="otherAccessories" name="otherAccessories">
                    </div>
                </section>

                <section class="form-section">
                    <h2>3. รายละเอียดการยืม</h2>
                    <div class="form-group">
                        <label for="purpose">วัตถุประสงค์การยืม</label>
                        <textarea id="purpose" name="purpose" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="startDate">วันที่และเวลายืม</label>
                        <input type="datetime-local" id="startDate" name="startDate" required>
                    </div>
                    <div class="form-group">
                        <label for="returnDate">วันที่และเวลาคืน (ที่คาดไว้)</label>
                        <input type="datetime-local" id="returnDate" name="returnDate" required>
                    </div>
                </section>

                <section class="form-section">
                    <h2>4. รูปถ่ายอุปกรณ์</h2>
                    <p>กรุณาถ่ายรูปอุปกรณ์ให้ครบทุกมุม</p>
                    <div class="photo-upload-grid">
                        <div class="photo-upload-item">
                            <label for="photoFront">ด้านหน้า</label>
                            <input type="file" id="photoFront" name="photoFront" accept="image/*" capture="environment" class="photo-input">
                            <img id="previewFront" class="photo-preview" alt="รูปด้านหน้า">
                        </div>
                        <div class="photo-upload-item">
                            <label for="photoBack">ด้านหลัง</label>
                            <input type="file" id="photoBack" name="photoBack" accept="image/*" capture="environment" class="photo-input">
                            <img id="previewBack" class="photo-preview" alt="รูปด้านหลัง">
                        </div>
                        <div class="photo-upload-item">
                            <label for="photoLeft">ด้านซ้าย</label>
                            <input type="file" id="photoLeft" name="photoLeft" accept="image/*" capture="environment" class="photo-input">
                            <img id="previewLeft" class="photo-preview" alt="รูปด้านซ้าย">
                        </div>
                        <div class="photo-upload-item">
                            <label for="photoRight">ด้านขวา</label>
                            <input type="file" id="photoRight" name="photoRight" accept="image/*" capture="environment" class="photo-input">
                            <img id="previewRight" class="photo-preview" alt="รูปด้านขวา">
                        </div>
                        <div class="photo-upload-item">
                            <label for="photoAccessories">อุปกรณ์เสริม</label>
                            <input type="file" id="photoAccessories" name="photoAccessories" accept="image/*" capture="environment" class="photo-input">
                            <img id="previewAccessories" class="photo-preview" alt="รูปอุปกรณ์เสริม">
                        </div>
                    </div>
                </section>

                <section class="form-section">
                    <h2>5. ลายเซ็นผู้ยืม</h2>
                    <div class="signature-pad-container">
                        <canvas id="signature-pad-borrower"></canvas>
                    </div>
                    <button type="button" id="clear-signature-borrower" class="secondary-button">ล้าง</button>
                </section>

                <div class="submission-area">
                    <button type="submit" class="primary-button">ส่งคำขอยืม</button>
                </div>
            </form>
        </div>

        <!-- Step 2: Supervisor Approval -->
        <div id="supervisor-step" class="hidden">
            <section class="form-section">
                <h2>สำหรับผู้บังคับบัญชาอนุมัติ</h2>
                <div id="summary-for-supervisor" class="summary-view"></div>
                <h3>ลายเซ็นผู้บังคับบัญชา</h3>
                <div class="signature-pad-container">
                    <canvas id="signature-pad-supervisor"></canvas>
                </div>
                <button type="button" id="clear-signature-supervisor" class="secondary-button">ล้าง</button>
                <div class="submission-area">
                    <button type="button" id="approve-button" class="primary-button">อนุมัติ</button>
                </div>
            </section>
        </div>

        <!-- Step 3: IT Verification -->
        <div id="it-step" class="hidden">
            <section class="form-section">
                <h2>สำหรับเจ้าหน้าที่ IT ตรวจสอบ</h2>
                <div id="summary-for-it" class="summary-view"></div>
                <h3>ลายเซ็นเจ้าหน้าที่ IT</h3>
                <div class="signature-pad-container">
                    <canvas id="signature-pad-it"></canvas>
                </div>
                <button type="button" id="clear-signature-it" class="secondary-button">ล้าง</button>
                <div class="submission-area">
                    <button type="button" id="verify-button" class="primary-button">ตรวจสอบและยืนยัน</button>
                </div>
            </section>
        </div>
        
        <!-- Step 4: Final Summary & Export -->
        <div id="summary-step" class="hidden">
            <section class="form-section">
                <h2>การขอยืมเสร็จสมบูรณ์</h2>
                <p>ข้อมูลการขอยืมได้รับการอนุมัติและตรวจสอบเรียบร้อยแล้ว</p>
                <div id="export-content">
                    <!-- Content for PDF export will be generated here -->
                </div>
                <div class="submission-area">
                    <button type="button" id="export-pdf-button" class="primary-button">ส่งออกเป็น PDF</button>
                    <button type="button" id="new-request-button" class="secondary-button">สร้างคำขอใหม่</button>
                </div>
            </section>
        </div>

        <!-- History Modal -->
        <div id="history-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ประวัติการยืม</h2>
                    <button id="close-history-modal" class="close-button">&times;</button>
                </div>
                <div id="history-content" class="modal-body">
                    <!-- History items will be injected here -->
                </div>
            </div>
        </div>


        <div id="loading-overlay" class="hidden">
            <div class="spinner"></div>
            <p>กำลังดำเนินการ...</p>
        </div>

    </main>
    <script type="module" src="index.tsx"></script>
    <script>
        // Register Firebase Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/firebase-messaging-sw.js')
                .then(function(registration) {
                    console.log('Service Worker registered with scope:', registration.scope);
                }).catch(function(err) {
                    console.log('Service Worker registration failed:', err);
                });
        }
    </script>
</body>
</html>